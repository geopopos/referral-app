name: Deploy to Digital Ocean VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, pdo_pgsql, zip, gd, redis
        coverage: none

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Composer dependencies (with dev for testing)
      run: composer install --optimize-autoloader --no-interaction

    - name: Install NPM dependencies
      run: npm ci

    - name: Build assets
      run: npm run build

    - name: Run tests
      run: |
        cp .env.example .env
        php artisan key:generate
        composer test

    - name: Install production dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction

    - name: Create deployment archive
      run: |
        # Clear any cache files that might change during archiving
        rm -f .phpunit.result.cache
        php artisan config:clear || true
        php artisan cache:clear || true
        php artisan view:clear || true
        php artisan route:clear || true
        
        # Wait for any remaining processes to complete
        sleep 3
        
        # Debug: Show current directory and files
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        
        # Create comprehensive exclude file
        cat > .tarignore << 'EOF'
        .git
        .github
        node_modules
        .env
        .env.*
        .phpunit.result.cache
        storage/logs
        storage/framework/cache
        storage/framework/sessions
        storage/framework/views
        storage/framework/testing
        bootstrap/cache
        tests
        vendor
        *.log
        *.tmp
        *.cache
        .DS_Store
        Thumbs.db
        deployment.tar.gz
        .tarignore
        EOF
        
        # Create archive with flags to handle changing files gracefully
        tar --ignore-failed-read --warning=no-file-changed -czf deployment.tar.gz --exclude-from=.tarignore .
        
        # Verify archive was created
        if [ -f deployment.tar.gz ]; then
          echo "‚úÖ Archive created successfully"
          ls -lh deployment.tar.gz
        else
          echo "‚ùå Archive creation failed"
          exit 1
        fi

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Set variables
          APP_NAME="referral-app"
          DEPLOY_PATH="/var/www/$APP_NAME"
          CURRENT_PATH="$DEPLOY_PATH/current"
          RELEASES_PATH="$DEPLOY_PATH/releases"
          SHARED_PATH="$DEPLOY_PATH/shared"
          RELEASE_NAME=$(date +%Y%m%d%H%M%S)
          RELEASE_PATH="$RELEASES_PATH/$RELEASE_NAME"
          
          # Store release name for subsequent steps
          echo $RELEASE_NAME > /tmp/release_name.txt
          
          # Create directory structure
          mkdir -p $RELEASES_PATH $SHARED_PATH/storage/logs $SHARED_PATH/storage/framework/{cache,sessions,views} $SHARED_PATH/storage/app
          
          # Create release directory
          mkdir -p $RELEASE_PATH
          
          echo "Deploying release: $RELEASE_NAME"
          echo "Release path: $RELEASE_PATH"

    - name: Upload and extract files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deployment.tar.gz"
        target: "/tmp/"

    - name: Complete deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Set variables
          APP_NAME="referral-app"
          DEPLOY_PATH="/var/www/$APP_NAME"
          CURRENT_PATH="$DEPLOY_PATH/current"
          RELEASES_PATH="$DEPLOY_PATH/releases"
          SHARED_PATH="$DEPLOY_PATH/shared"
          
          # Read the release name from the previous step
          RELEASE_NAME=$(cat /tmp/release_name.txt)
          RELEASE_PATH="$RELEASES_PATH/$RELEASE_NAME"
          
          echo "Completing deployment for release: $RELEASE_NAME"
          echo "Release path: $RELEASE_PATH"
          
          # Verify release directory exists
          if [ ! -d "$RELEASE_PATH" ]; then
            echo "‚ùå Release directory does not exist: $RELEASE_PATH"
            echo "Available releases:"
            ls -la $RELEASES_PATH/
            exit 1
          fi
          
          # Extract files to release directory
          cd $RELEASE_PATH
          tar -xzf /tmp/deployment.tar.gz
          rm /tmp/deployment.tar.gz
          
          # Create .env file from secrets
          cat > $RELEASE_PATH/.env << 'EOF'
          ${{ secrets.ENV_FILE }}
          EOF
          
          # Create symlinks to shared directories
          rm -rf $RELEASE_PATH/storage
          ln -nfs $SHARED_PATH/storage $RELEASE_PATH/storage
          
          # Set permissions
          chown -R www-data:www-data $RELEASE_PATH
          chown -R www-data:www-data $SHARED_PATH
          chmod -R 755 $RELEASE_PATH
          chmod -R 775 $SHARED_PATH/storage
          
          # Install Composer dependencies on server
          cd $RELEASE_PATH
          composer install --no-dev --optimize-autoloader --no-interaction
          
          # Laravel setup
          php artisan key:generate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # Run database migrations
          php artisan migrate --force
          
          # Update current symlink atomically
          ln -nfs $RELEASE_PATH $CURRENT_PATH
          
          # Restart services
          sudo systemctl reload nginx
          sudo supervisorctl restart laravel-worker:*
          
          # Clean up old releases (keep last 5)
          cd $RELEASES_PATH
          ls -t | tail -n +6 | xargs rm -rf
          
          echo "Deployment completed successfully!"
          echo "Application is now live at: http://${{ secrets.HOST }}"

    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Wait longer for services to start
          echo "üîÑ Waiting for services to start..."
          sleep 10
          
          # Check nginx status
          echo "üîç Checking nginx status..."
          if sudo systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx is running"
          else
            echo "‚ùå Nginx is not running"
            sudo systemctl status nginx
          fi
          
          # Check PHP-FPM status
          echo "üîç Checking PHP-FPM status..."
          if sudo systemctl is-active --quiet php8.2-fpm; then
            echo "‚úÖ PHP-FPM is running"
          else
            echo "‚ùå PHP-FPM is not running"
            sudo systemctl status php8.2-fpm
          fi
          
          # Check if application files exist
          echo "üîç Checking application files..."
          APP_PATH="/var/www/referral-app/current"
          
          # Check if current symlink exists
          if [ -L "$APP_PATH" ]; then
            echo "‚úÖ Current symlink exists"
            echo "Symlink target: $(readlink $APP_PATH)"
          else
            echo "‚ùå Current symlink missing"
            echo "Contents of /var/www/referral-app/:"
            ls -la /var/www/referral-app/
          fi
          
          # Check if Laravel files exist
          if [ -f "$APP_PATH/public/index.php" ]; then
            echo "‚úÖ Laravel application files found"
            echo "Application structure:"
            ls -la $APP_PATH/
          else
            echo "‚ùå Laravel application files missing"
            if [ -d "$APP_PATH" ]; then
              echo "Directory contents:"
              ls -la $APP_PATH/
            else
              echo "Application path does not exist"
            fi
          fi
          
          # Test application with multiple URLs
          echo "üîç Testing application response..."
          
          # Test localhost
          if curl -f -s -o /dev/null http://localhost; then
            echo "‚úÖ Application responding on localhost"
          else
            echo "‚ö†Ô∏è  Application not responding on localhost"
            echo "Nginx error log:"
            sudo tail -n 10 /var/log/nginx/error.log || echo "No nginx error log found"
          fi
          
          # Test with domain (if available)
          if curl -f -s -o /dev/null http://${{ secrets.HOST }}; then
            echo "‚úÖ Application responding on domain"
          else
            echo "‚ö†Ô∏è  Application not responding on domain"
          fi
          
          # Check Laravel logs
          echo "üîç Checking Laravel logs..."
          STORAGE_PATH="/var/www/referral-app/shared/storage/logs"
          if [ -f "$STORAGE_PATH/laravel.log" ]; then
            echo "Recent Laravel log entries:"
            sudo tail -n 5 "$STORAGE_PATH/laravel.log" || echo "Could not read Laravel logs"
          else
            echo "No Laravel log file found"
          fi
          
          # Check queue workers
          echo "üîç Checking queue workers..."
          if sudo supervisorctl status laravel-worker:* 2>/dev/null | grep -q RUNNING; then
            echo "‚úÖ Queue workers are running"
          else
            echo "‚ö†Ô∏è  Queue workers may not be running properly"
            sudo supervisorctl status laravel-worker:* 2>/dev/null || echo "No queue workers configured"
          fi
          
          # Final status
          if curl -f -s -o /dev/null http://localhost || curl -f -s -o /dev/null http://${{ secrets.HOST }}; then
            echo "üéâ Deployment successful! Application is accessible."
          else
            echo "‚ö†Ô∏è  Deployment completed but application may need manual verification."
            echo "Please check your server configuration."
          fi
